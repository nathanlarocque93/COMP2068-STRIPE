<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link href="stylesheets/style.css" rel="stylesheet" />
    <script src="https://js.stripe.com/v3"></script>
    <script>
        var stripePublicKey = '<%= stripePublicKey %>'
    </script>
    <title>Marketplace</title>
</head>

<body>

    <main class="container">

        <h1 class="mt-2 text-warning" style="text-shadow: 2px 2px 2px black;">Welcome to Marketplace!</h1>

        <form class="d-print-block gap-2 p-2 rounded-3" method="#">
            <% products.items.forEach((product) => { %>
                <div class="mb-3 label-row text-white p-2 product-row">
                    <label for="item1" class="form-label fw-bold pe-3"><%= product.name %></label>
                    <span class="product-price">$<%= product.price / 100 %></span>
                    <span class="product-id" hidden><%= product.priceTag %></span>
                    <input type="number" value="0" min="0" max="5" class="product-quantity" onclick="getTotal()" />

                </div>
            <% }) %>
            <div class="container">

                <div class="row justify-content-between">
                    <div class="col">
                        <h3 class="text-primary" style="text-shadow: 1px 1px 1px black;">Total</h3>
                        <p class="text-primary" style="text-shadow: 1px 1px 1px black;" id="totalPrice">$0.00</p>

                        <script>
                            
                            
                            function getTotal() {

                                var productSections = document.getElementsByClassName('product-row')
                                var total = 0

                                for (var i = 0; i < productSections.length; i++) {
                                    var productSelected = productSections[i]
                                    var productPrice = productSelected.getElementsByClassName('product-price')[0]
                                    var price = parseFloat(productPrice.innerText.replace('$', ''))

                                    var productQuantity = productSelected.getElementsByClassName('product-quantity')[0]
                                    var quantity = productQuantity.value

                                    total += price * quantity
                                    one = productSections[i].value
                                }
                                total = Math.round(total*100) / 100
                                document.getElementById('totalPrice').innerText = '$' + total.toFixed(2)
                            }
                        </script>

                    </div>
                    <div class="col-2 d-flex align-items-center text-center">
                        <button class="btn btn-primary rounded-2" id="checkout-button" role="link" type="button">Purchase</button>
                    </div>
                </div>
                <div id="error-message"></div>
            </div>

        </form>

            <div id="error-message"></div>
            <script>

                (function() {
                  var stripe = Stripe('pk_test_51LPtuvE38DBPt8jlMdTxR4eACmGS2FCvxEHCKnipeJCnyYgZs3b3eF61DEFg0NQSOIDEiw3L6Xnp9CydB5YkIdiu001jQjNYFW');
                
                  var totalPriceGet = document.getElementById('totalPrice')
                        price_1LPyw6E38DBPt8jlVdX4s1h6 = parseFloat(totalPriceGet.innerText.replace('$', '')) * 100
                            console.log(totalPrice)

                  var checkoutButton = document.getElementById('checkout-button');
                  checkoutButton.addEventListener('click', function () {
                    /*
                     * When the customer clicks on the button, redirect
                     * them to Checkout.
                     */

                     var productSections = document.getElementsByClassName('product-row')
                     const lineItems = []
                     for (var i = 0; i < productSections.length; i++) {

                    var productSelected = productSections[i];
                    var priceId = productSelected.getElementsByClassName("product-id")[0].innerHTML;
                    var productQuantity = productSelected.getElementsByClassName('product-quantity')[0];
                    var quantity = productQuantity.value;

                    if (quantity > 0) {

                        lineItems.push({ price: priceId, quantity: parseInt(quantity)});
                    };


                    };
                    stripe.redirectToCheckout({
                      lineItems,
                      mode: 'payment',
                      /*
                       * Do not rely on the redirect to the successUrl for fulfilling
                       * purchases, customers may not always reach the success_url after
                       * a successful payment.
                       * Instead use one of the strategies described in
                       * https://stripe.com/docs/payments/checkout/fulfill-orders
                       */
                      successUrl: 'http://localhost:3000/success',
                      cancelUrl: 'http://localhost:3000/',
                    })
                    .then(function (result) {
                      if (result.error) {
                        /*
                         * If `redirectToCheckout` fails due to a browser or network
                         * error, display the localized error message to your customer.
                         */
                        var displayError = document.getElementById('error-message');
                        displayError.textContent = result.error.message;
                      }
                    });
                  });
                })();
                </script>
    </main>

</body>

</html>